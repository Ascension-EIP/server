#!/usr/bin/env python3
import os
import re
import sys



is_github_actions = 'GITHUB_ACTIONS' in os.environ and os.environ['GITHUB_ACTIONS'] == 'true'



def load_keywords():
    keywords_file = ".github/keywords.txt"
    keywords = []
    try:
        with open(keywords_file, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#'):
                    keywords.append(line)
    except Exception as e:
        prefix = "::error file={keywords_file}::".format(keywords_file=keywords_file) if is_github_actions else ""
        print(f"{prefix}Cannot read keywords file: {e}")
        sys.exit(1)

    return keywords



def is_kebab_case(s):
    # kebab-case: lowercase letters/numbers separated by single hyphens, no leading/trailing hyphen
    return re.match(r'^[a-z0-9]+(?:-[a-z0-9]+)*$', s) is not None



def validate_branch(branch, keywords):
    # Allow exact names main and dev
    if branch in ("main", "dev"):
        return True, "Branch allowed: main or dev"

    if '/' not in branch:
        return False, "Branch must be either 'main'/'dev' or of form <type>/<description>"

    type_part, desc_part = branch.split('/', 1)
    if not type_part:
        return False, "Branch type is empty"

    if type_part not in keywords:
        return False, f"Unknown branch type '{type_part}'. Allowed types: {', '.join(keywords)}"

    if not desc_part:
        return False, "Branch description must not be empty"

    if not is_kebab_case(desc_part):
        return False, "Branch description must be kebab-case (lowercase letters/numbers and hyphens)"

    return True, "Branch name is valid"



if __name__ == '__main__':
    if len(sys.argv) != 2:
        prefix = "::error::" if is_github_actions else ""
        print(f"{prefix}Usage: check_branch <branch_name>")
        sys.exit(1)

    branch_name = sys.argv[1]
    keywords = load_keywords()

    if not keywords:
        prefix = "::error::" if is_github_actions else ""
        print(f"{prefix}No keywords found in configuration")
        sys.exit(1)

    valid, message = validate_branch(branch_name, keywords)
    if valid:
        prefix = "::notice title=Branch format::" if is_github_actions else ""
        print(f"{prefix}{message}")
        sys.exit(0)
    else:
        prefix = "::error title=Invalid branch format::" if is_github_actions else ""
        print(f"{prefix}{message}")
        print(f"{prefix}Received: {branch_name}")
        sys.exit(1)
